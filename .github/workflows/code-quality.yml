name: Code Quality

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  checkstyle:
    name: Checkstyle Analysis
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [Authentication, Notes, Password, Cloud, Eureka]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run Checkstyle - ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          ./mvnw checkstyle:checkstyle -B
        continue-on-error: true
      
      - name: Upload Checkstyle Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkstyle-report-${{ matrix.service }}
          path: ${{ matrix.service }}/target/checkstyle-result.xml

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [Authentication, Notes, Password, Cloud, Eureka]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run Tests with Coverage - ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          ./mvnw test jacoco:report -B
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ${{ matrix.service }}/target/site/jacoco/jacoco.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage
          fail_ci_if_error: false
      
      - name: Generate Coverage Badge
        id: coverage
        run: |
          cd ${{ matrix.service }}/target/site/jacoco
          COVERAGE=$(grep -oP '(?<=<td>Total</td><td class="bar">)[0-9]+(?=%)' index.html | head -1)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage for ${{ matrix.service }}: $COVERAGE%"
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.service }}
          path: ${{ matrix.service }}/target/site/jacoco/

  pmd-analysis:
    name: PMD Static Analysis
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [Authentication, Notes, Password, Cloud, Eureka]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Run PMD - ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          ./mvnw pmd:pmd -B
        continue-on-error: true
      
      - name: Upload PMD Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pmd-report-${{ matrix.service }}
          path: ${{ matrix.service }}/target/pmd.xml

  spotbugs:
    name: SpotBugs Analysis
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        service: [Authentication, Notes, Password, Cloud, Eureka]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Compile ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          ./mvnw clean compile -B
      
      - name: Run SpotBugs - ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          ./mvnw spotbugs:spotbugs -B
        continue-on-error: true
      
      - name: Upload SpotBugs Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spotbugs-report-${{ matrix.service }}
          path: ${{ matrix.service }}/target/spotbugsXml.xml

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [checkstyle, code-coverage, pmd-analysis, spotbugs]
    if: always()
    
    steps:
      - name: Generate Quality Report
        run: |
          echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Checkstyle | Coverage | PMD | SpotBugs |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|----------|-----|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | ${{ needs.checkstyle.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.code-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.pmd-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.spotbugs.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notes | ${{ needs.checkstyle.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.code-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.pmd-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.spotbugs.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Password | ${{ needs.checkstyle.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.code-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.pmd-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.spotbugs.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloud Gateway | ${{ needs.checkstyle.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.code-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.pmd-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.spotbugs.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Eureka | ${{ needs.checkstyle.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.code-coverage.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.pmd-analysis.result == 'success' && 'âœ…' || 'âš ï¸' }} | ${{ needs.spotbugs.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Download detailed reports from the Artifacts section" >> $GITHUB_STEP_SUMMARY
